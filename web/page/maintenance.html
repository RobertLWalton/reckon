<html>
<head>
<!--
File:	maintenance.html
Author:	Robert L Walton <walton@acm.org>
Date:	Mon Dec 25 06:15:48 EST 2023

The authors have placed RECKON (its files and the
content of these files) in the public domain; they
make no warranty and accept no liability for RECKON.
-->

<meta http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate" />

<title>RECKON Maintenance</title>
<link href='page.css' rel='stylesheet'/>


</head>

<body>

<h1>RECKON Maintenance</h1>

<ul id='toc'>
<li><a href="#parameter-index">Parameter Index</a>
<li><a href="#directories">Directories</a>
<li><a href="#installation">Installation</a>
<li><a href="#users">Users</a>
<li><a href="#throttling">Throttling</a>
<li><a href="#logging">Logging</a>
<li><a href="#security">Security</a>
</ul>

<h2 id='parameter-index'>Parameter Index</h2>

Parameters can be set in <code>WDIR/index.php</code>, but if not
set there are set to default values before they are used.

<table class='center'>
<tr class='header'>
<th>Parameter</th>
<th>Section</th>
<th>Default Value</th>
</tr>
<tr>
<th>IDIR</th>
<td><a href='#directories'>Directories</td>
<td>(must set in <code>index.php</code>)</td>
</tr>
<tr>
<th>DDIR</th>
<td><a href='#directories'>Directories</td>
<td>(must set in <code>index.php</code>)</td>
</tr>
<tr>
<th>throttle_limit</th>
<td><a href='#throttling'>Throttling</td>
<td>4 (times per throttle period)</td>
</tr>
<tr>
<th>throttle_period</th>
<td><a href='#throttling'>Throttling</td>
<td>24*60*60 (seconds = 1 day)</td>
</tr>
<tr>
<th>throttle_message</th>
<td><a href='#throttling'>Throttling</td>
<td><code>WAIT 24 HOURS AND TRY AGAIN</code></td>
</tr>
<tr>
<th>throttle_time</th>
<td><a href='#throttling'>Throttling</td>
<td>10 ( seconds )</td>
</tr>
<tr>
<th>random_device</th>
<td><a href='#throttling'>Throttling</td>
<td><code>/dev/urandom</code></td>
</tr>
<tr>
<th>ipaddr_check</th>
<td><a href='#security'>Security</td>
<td><code>true</code></td>
</tr>
</table>


<h2 id='directories'>Directories</h2>

<p>
The following directories are created when RECKON is installed and run:

<ul class='itemize'>
<li> <b>IDIR</b> The installation directory, containing
     <code>IDIR/min</code>,
     <code>IDIR/mex</code>,
     <code>IDIR/layered</code>, and
     <code>IDIR/reckon</code>.
     Only <code>IDIR/reckon/web/page</code> is visible on the web.
<li> <b>WDIR</b> The web directory which is the target of
     the symbolic link <code>/var/www/html/reckon -> WDIR</code>.
     Contains just a modified copy of
     <code>IDIR/reckon/web/include/index.php</code>,
     and a symbolic link <code>page -> IDIR/reckon/web/page</code>.
<li> <b>DDIR</b> Data directory.  NOT visible on the web.
</ul>

None of these directories should be ancestors of another
of these directories.

Subdirectories of <code>DDIR</code> are:

<ul class='itemize'>
<li> <b>IDIR/users/ID</b>  Directory in which jobs for user ID are
     run.  See <a href='#users'>Users</a>.
<li> <b>IDIR/throttle</b>  Directory in which information is kept to
     throttle creation of users.  See <a href='#throttling'>Throttling</a>.
</ul>

<h2 id='installation'>Installation</h2>

<ol class='steps'>
<li> Pick an installation directory IDIR.
<li> Install `min' in IDIR.  Specifically:
	<pre class='code'>
	cd IDIR
	git clone git@github.com:RobertLWalton/min.git min
	cd min/lib
	make</pre>
<p>
If you want to test `min', execute:
	<pre class='code'>
	cd IDIR/min/test
	make
	make</pre>
<p>
The output of the <b>second</b> <code>make</code> should be nothing
but lines beginning with `<code>DIFFING</code>'.
An exception is after:
	<pre class='code'>
	DIFFING min_relocation_optimization_test.test ...</pre>
<p>
there may be output indicating minor differences between the test
output and the test output reference.  This is OK; it just means
that different versions of the compiler are doing things slightly differently.

<li> Install `mex' in IDIR.  Specifically:
	<pre class='code'>
	cd IDIR
	git clone git@github.com:RobertLWalton/mex.git mex
	cd mex/lib
	make</pre>
<p>
If you want to test `mex', execute:
	<pre class='code'>
	cd IDIR/mex/test
	make
	make</pre>
<p>
The output of the <b>second</b> <code>make</code> should be nothing
but lines beginning with `<code>DIFFING</code>'.
An exception is that in one test some processors return
<code>nan</code> and some return <code>-nan</code>.

<li> Install `layered' in IDIR.  Specifically:
	<pre class='code'>
	cd IDIR
	git clone git@github.com:RobertLWalton/layered.git layered
	cd layered/lib
	make</pre>
<p>
If you want to test `layered', execute:
	<pre class='code'>
	cd IDIR/layered/test
	make
	make</pre>
<p>
The output of the <b>second</b> <code>make</code> should be nothing
but lines beginning with `<code>DIFFING</code>'.

<li> Install `reckon' in IDIR.  Specifically:
	<pre class='code'>
	cd IDIR
	git clone git@github.com:RobertLWalton/reckon.git reckon
	cd reckon/lib
	make</pre>
<p>
If you want to test `reckon', execute:
	<pre class='code'>
	cd IDIR/reckon/test
	make
	make</pre>
<p>
The output of the <b>second</b> <code>make</code> should be nothing
but lines beginning with `<code>DIFFING</code>'.
     
</ol>

<h2 id='users'>Users</h2>

<p>
A RECKON <b>user</b> is a browser.  The ID of the user is stored in
the browser's local memory.  If a browser has no ID, one is created
during startup and loaded into the local memory by the client page.
The first time a user submits a file to the server, the directory
<code>DDIR/users/ID</code> is created.  Runs for the user are executed
in this directory.
<p>
User ID's are 32 digit random hexadecimal numbers.
</p>

<h2 id='throttling'>Throttling</h2>

The rate at which new user IDs can be created is limited, a process
called <b>throttling</b>.

When a new user ID needs to be created, the following steps are
followed:

<ol class='steps'>
<li>The file <code>DDIR/log/IPADDR.log</code> is locked, where IPADDR
is the IP address of the browser requesting an ID.  If the file does
not exist, it is first created.
<p> Then the file is read and the <code>throttle_limit</code> (default 4)
entry from the end is examined to see when the ID creation it records
happended.  If this time is less than
<code>throttle_period</code> seconds (default 24*60*60 = 1 day),
the request is redirected to a page that just contains the message
<code>throttle_message</code> (default, `WAIT 24 HOURS AND TRY AGAIN'),
and the file is unlocked.

<li>The file <code>DDIR/log/id.log</code> is locked and its modification
time is read.  If the current time minus the modification time is less
than <code>throttle_time</code> seconds (default 10), the program sleeps
for this difference time.

<li>The ID is created by reading <code>random_device</code>
(default <code>/dev/urandom</code>), log lines are
written to both log files (see <a href='#logging'>Logging</a>), and
both log files are unlocked.
</ol>

<h2 id='logging'>Logging</h2>

<p>
Log entries are each single lines appended to log files.  Each
line consists of elements separated by a single space.
There is NO space before the first element or after the last
element.  A missing element is indicated by consecutive single spaces.
<p>
The first element is always the time of day to the nearest second in
the format <code>Y-m-d\Th:i:sT</code> where Y is the year, m the month,
d the day, <code>\T</code> the literal character <code>T</code>,
h the hour, i the minute, s the second, and T the time zone.  The
time zone is the value of <code>time_zone</code>
(default <code>'America/New_York'</code>).
Example: <code>2023-12-23T08:07:25EST</code>.

<ul class='itemize'>
<li> <b>ID Creation Logging</b>  Log entries are written to
<code>DDIR/log/IPADDR.log</code> and <code>DDIR/log/id.log</code>
at times described in <a href=#throttling>Throttling</a>,
and <code>DDIR/log/ID.log</code> at a time described in
<a href=#security>Security</a>.
The entry format is:<br>
<code class='center'>TIME ID IPADDR HOST BROWSER</code>
<p>
Here TIME is as described above, ID is the user ID being assigned,
IPADDR is from <code>$_SESSION['IPADDR']</code> (see
<a href='#security'>Security</a>),
HOST is from 
<code>$_SERVER['REMOTE_HOST']</code>,
and BROWSER is from
<code>$_SERVER['HTTP_USER_AGENT']</code> with `(...)'s deleted
and horizontal spaces replaced by `;'s.

</ul>

<h2 id='security'>Security</h2>

All HTTP requests are made to <code>WDIR/index.php</code>
which sets parameters and passes the request on to
a page in the <code>IDIR/include</code> directory.

<ol class='steps'>
<li> The first GET request is passed to <code>startup.html</code>.
     This initiates a PHP session and stores
     <code>$_SERVER['REMOTE_ADDR']</code> in
     <code>$_SESSION['IPADDR']</code>.
     <p>
     All subsequent requests in the PHP session 
     are required to have their 
     <code>$_SERVER['REMOTE_ADDR']</code> match
     <code>$_SESSION['IPADDR']</code>, unless the
     parameter <code>ipaddr_check</code>
     (default <code>true</code>) is <code>false</code>.
     </p>

<li> The <code>startup.html</code> browser page creates
     a browser floating window and initializes it with
     a second GET request containing any user ID stored
     in the browser.  The second request is passed to
     <code>client.html</code>.
     <p>
     <code>Client.html</code> then accepts the user ID if given or creates
     it otherwise, and stores it in <code>$_SESSION['ID']</code>.
     It then writes a log entry to <code>DDIR/log/ID.log</code>,
     reads the new modification time of that file, and stores it
     in <code>$_SESSION['LOGIN_TIME']</code>.
     <p>
     All subsequent requests in the PHP session are required
     to pass a copy of the user ID that must match
     <code>$_SESSION['ID']</code>.  A subsequent request
     also requires that the current modification time of 
     <code>DDIR/log/ID.log</code> matches
     <code>$_SESSION['LOGIN_TIME']</code>.
     <p>
     Requests to reload the floating window with
     <code>client.html</code> are detected by the fact that
     <code>$_SESSION['LOGIN_TIME']</code> is set.  In this case
     the matches of the last paragraph are required, and if successful
     the floating window is reloaded without doing anything else.

<li> The <code>client.html</code> code in the floating window
     makes XMLHttpRequests (POSTs, not GETs) to <code>server.php</code>.
     
</ol>

</body>
</html>
