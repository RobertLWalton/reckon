<html>
<head>
<!--
File:	maintenance.html
Author:	Robert L Walton <walton@acm.org>
Date:	Sat Dec 23 20:26:16 EST 2023

The authors have placed RECKON (its files and the
content of these files) in the public domain; they
make no warranty and accept no liability for RECKON.
-->

<meta http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate" />

<title>RECKON Maintenance</title>
<link href='page.css' rel='stylesheet'/>


</head>

<body>

<h1>RECKON Maintenance</h1>

<ul id='toc'>
<li><a href="#parameter-index">Parameter Index</a>
<li><a href="#directories">Directories</a>
<li><a href="#installation">Installation</a>
<li><a href="#users">Users</a>
<li><a href="#throttling">Throttling</a>
<li><a href="#logging">Logging</a>
</ul>

<h2 id='parameter-index'>Parameter Index</h2>

Parameters are set in <code>WDIR/index.php</code>, but if not
set there are set to default values before they are used.

<table class='center'>
<tr>
<th>Parameter</th>
<th>Section</th>
<th>Default Value</th>
</tr>
<td><b>IDIR</b></td>
<td><a href='#directories'>Directories</td>
<td>----------</td>
<tr>
</table>


<h2 id='directories'>Directories</h2>

<p>
The following directories are created when RECKON is installed and run:

<ul class='itemize'>
<li> <b>IDIR</b> The installation directory, containing
     <code>IDIR/min</code>,
     <code>IDIR/mex</code>,
     <code>IDIR/layered</code>, and
     <code>IDIR/reckon</code>.
     Only <code>IDIR/reckon/web/page</code> is visible on the web.
<li> <b>WDIR</b> The web directory which is the target of
     the symbolic link <code>/var/www/html/reckon -> WDIR</code>.
     Contains just a modified copy of
     <code>IDIR/reckon/web/include/index.php</code>,
     and a symbolic link <code>page -> IDIR/reckon/web/page</code>.
<li> <b>DDIR</b> Data directory.  NOT visible on the web.
</ul>

None of these directories should be ancestors of another
of these directories.

Subdirectories of <code>DDIR</code> are:

<ul class='itemize'>
<li> <b>IDIR/users/ID</b>  Directory in which jobs for user ID are
     run.  See <a href='#users'>Users</a>.
<li> <b>IDIR/throttle</b>  Directory in which information is kept to
     throttle creation of users.  See <a href='#throttling'>Throttling</a>.
</ul>

<h2 id='installation'>Installation</h2>

<ol class='steps'>
<li> Pick an installation directory IDIR.
<li> Install `min' in IDIR.  Specifically:
	<pre class='code'>
	cd IDIR
	git clone git@github.com:RobertLWalton/min.git min
	cd min/lib
	make
	</pre>

If you want to test `min', execute:
	<pre class='code'>
	cd IDIR/min/test
	make
	make
	</pre>

The output of the <b>second</b> <code>make</code> should be nothing
but lines beginning with `<code>DIFFING</code>'.
An exception is after 
	<pre class='code'>
	DIFFING min_relocation_optimization_test.test ...
	</pre>

there may be output indicating minor differences between the test
output and the test output reference.  This is OK; it just means
that different versions of the compiler are doing things slightly differently.

<li> Install `mex' in IDIR.  Specifically:
	<pre class='code'>
	cd IDIR
	git clone git@github.com:RobertLWalton/mex.git mex
	cd mex/lib
	make
	</pre>

If you want to test `mex', execute:
	<pre class='code'>
	cd IDIR/mex/test
	make
	make
	</pre>

The output of the <b>second</b> <code>make</code> should be nothing
but lines beginning with `<code>DIFFING</code>'.
An exception is that in one test some processors return
<code>nan</code> and some return <code>-nan</code>.

<li> Install `layered' in IDIR.  Specifically:
	<pre class='code'>
	cd IDIR
	git clone git@github.com:RobertLWalton/layered.git layered
	cd layered/lib
	make
	</pre>

If you want to test `layered', execute:
	<pre class='code'>
	cd IDIR/layered/test
	make
	make
	</pre>

The output of the <b>second</b> <code>make</code> should be nothing
but lines beginning with `<code>DIFFING</code>'.

<li> Install `reckon' in IDIR.  Specifically:
	<pre class='code'>
	cd IDIR
	git clone git@github.com:RobertLWalton/reckon.git reckon
	cd reckon/lib
	make
	</pre>

If you want to test `reckon', execute:
	<pre class='code'>
	cd IDIR/reckon/test
	make
	make
	</pre>

The output of the <b>second</b> <code>make</code> should be nothing
but lines beginning with `<code>DIFFING</code>'.
     
</ol>

<h2 id='users'>Users</h2>

<p>
A RECKON <b>user</b> is a browser.  The ID of the user is stored in
the browser's local memory.  If a browser has no ID, one is created
during startup and loaded into the local memory by the client page.
The first time a user submits a file to the server, the directory
<code>DDIR/users/ID</code> is created.  Runs for the user are executed
in this directory.
<p>
User ID's are 32 digit random hexadecimal numbers.
</p>

<h2 id='throttling'>Throttling</h2>

The rate at which new user IDs can be created is limited, a process
called <b>throttling</b>.

When a new user ID needs to be created, the following steps are
followed:

<ol class='steps'>
<li>The file <code>DDIR/log/IPADDR.log</code> is locked, where IPADDR
is the IP address of the browser requesting an ID.  If the file does
not exist, it is first created.
<p> Then the file is read and the <code>throttle_limit</code> (default 4)
entry from the end is examined to see when the ID creation it records
happended.  If this time is less than
<code>throttle_period</code> seconds (default 24*60*60 = 1 day),
the request is redirected to a page that just contains the message
<code>throttle_message</code> (default, `WAIT 24 HOURS AND TRY AGAIN'),
and the file is unlocked.

<li>The file <code>DDIR/log/id.log</code> is locked and its modification
time is read.  If the current time minus the modification time is less
than <code>throttle_time</code> seconds (default 10), the program sleeps
for this difference time.

<li>The ID is created by reading <code>random_device</code>
(default <code>/dev/urandom</code>), log lines are
written to both log files (see <a href='#logging'>Logging</a>), and
both log files are unlocked.
</ol>

<h2 id='logging'>Logging</h2>

<p>
Log entries are each single lines appended to log files.  Each
line consists of elements separated by a single space.
There is NO space before the first element or after the last
element.  A missing element is indicated by consecutive single spaces.
<p>
The first element is always the time of day to the nearest second in
the format <code>Y-m-d\Th:i:sT</code> where Y is the year, m the month,
d the day, <code>\T</code> the literal character <code>T</code>,
h the hour, i the minute, s the second, and T the time zone.  The
time zone is the value of <code>time_zone</code>
(default <code>'America/New_York'</code>).
Example: <code>2023-12-23T08:07:25EST</code>.

<ul class='itemize'>
<li> <b>ID Creation Logging</b>  Log entries are written to
<code>DDIR/log/IPADDR.log</code> and <code>DDIR/log/id.log</code>
at times described under <a href=#throttling>throttling</a>.
The entry format is:<br>
<code class='center'>TIME ID IPADDR BROWSER</code>
<p>
Here TIME is as described above, ID is the user ID being assigned,
IPADDR is from <code>$_SESSION['IPADDR']</code> (see
<a href='#security'>Security</a>), and BROWSER is from
<code>$_SERVER['HTTP_USER_AGENT']</code> with `(...)'s deleted
and horizontal spaces replaced by `;'s.

</ul>


</body>
</html>
